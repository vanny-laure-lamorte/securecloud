#### Sqitch

1. Télécharger l’image Docker de Sqitch
```bash
docker pull sqitch/sqitch:latest
```
2. Vérifier que Sqitch est bien installé et voir sa version
```bash
docker run --rm -it sqitch/sqitch:latest --version
```
3. Cette commande permet de créer un dossier 'migrations' qui contiendra:
    - 3 sous dossiers de configuration (deploy, revert et verify)
    - fichier sqitch.conf
    - fichier sqitch.plan

   remplacer <path> par le chemin souhaité. Dans notre cas "\services\auth-service" pour créer un dossier migrations dans auth-service.

```bash
docker run --rm -it `
  -v "${PWD}\services\auth-service\migrations:/repo" `
  -w /repo `
  sqitch/sqitch:latest init auth pg
```

4. Générer des scripts de migrations dans deploy, revert et verify. Voici le nommage des fichiers "<date du jour>_version_migrations"
```bash
docker run --rm -it `
  -v "${PWD}\services\auth-service/migrations:/repo" `
  -w /repo `
  sqitch/sqitch:latest add "$(date +%Y%m%d%H%M%S)_version_migrations" -n "Create table x"
```
5. Modifier le fichier sqitch.conf en de-commantant le contenu et en spécifiant 'engine'. Dans notre cas on mettre 'pg' pour Postegres.
```bash
[core]
	engine = pg
	plan_file = sqitch.plan
	top_dir = .
```
6. Vérifier que le nom des 3 fichiers .sql correspond à ceux dans squitch.plan.
Dans notre cas les fichiers portent le nom de '20251031_version_migrations'. Voici le squitch.plan

```bash
%syntax-version=1.0.0
%project=auth

20251031_version_migrations 2025-10-31T13:34:46Z sqitch <sqitch@53cf65d3ae71>

```

7. Supprimer '-- XXX Add DDLs here.' et remplir les 3 fichiers sql

```bash

# Deploy
-- Generated by the database client.
CREATE TABLE connexion(
    id SERIAL NOT NULL,
    email varchar(255) NOT NULL,
    password varchar(255) NOT NULL,
    account_status varchar(50) DEFAULT 'active'::character varying,
    login_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    logout_time timestamp without time zone,
    user_id integer NOT NULL,
    PRIMARY KEY(id)
);

# Revert

DROP TABLE IF EXISTS connexion;

# Verify

SELECT 1 FROM connexion LIMIT 1;

```

8. Déployer les migrations sur PostgreSQL. Remplacer <action> par:
    - deploy: lancer les scripts de création ou de modification
    - revert: annuler les changements faits dans deploy/
    -verify: vérifier que la migration s’est bien appliquée
Si cette commande ne fonctionne pas, supprimer le registre Sqitch
```bash
$pw = Get-Content ./secrets/auth_db_password.txt -Raw
docker run --rm -it `
  -v "${PWD}/services/auth-service/migrations:/repo" `
  --network securecloud_default `
  -e PGPASSWORD="$pw" `
  sqitch/sqitch:latest `
  <action> db:pg://postgres@auth-db:5432/auth_service --chdir /repo/
```

9. Déployer les migrations sur PostgreSQL. Si cette commande ne fonctionne pas, supprimer le registre Sqitch
```bash
$pw = Get-Content ./secrets/auth_db_password.txt -Raw
docker run --rm -it `
  -v "${PWD}/services/auth-service/migrations:/repo" `
  --network securecloud_default `
  -e PGPASSWORD="$pw" `
  sqitch/sqitch:latest `
  deploy db:pg://postgres@auth-db:5432/auth_service --chdir /repo/
```