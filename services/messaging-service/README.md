#### Sqitch

1. Download the Sqitch Docker image
```bash
docker pull sqitch/sqitch:latest
```
2. Verify that Sqitch is installed and check its version
```bash
docker run --rm -it sqitch/sqitch:latest --version
```

3. Initialize the migrations directory

This command creates a migrations folder containing:
- Three subdirectories: deploy, revert, and verify
- The sqitch.conf file
- The sqitch.plan file

Replace <path> with the desired location.

In our case: \services\messaging-service to create the migrations folder inside messaging-service.

```bash
docker run --rm -it `
  -v "${PWD}\services\messaging-service\migrations:/repo" `
  -w /repo `
  sqitch/sqitch:latest init messaging pg
```

4. Generate migration scripts

This command generates migration scripts in the deploy, revert, and verify directories.

The naming convention is: <current_date>_version_migrations
```bash
docker run --rm -it `
  -v "${PWD}\services\messaging-service/migrations:/repo" `
  -w /repo `
  sqitch/sqitch:latest add "$(date +%Y%m%d%H%M%S)_version_migrations" -n "Create table x"
```
5. Configure sqitch.conf

Uncomment the content and specify the database engine.
In our case, we use pg for PostgreSQL.
```bash
[core]
	engine = pg
	plan_file = sqitch.plan
	top_dir = .
```
6. Verify migration filenames

Ensure that the names of the three .sql files match the entry in sqitch.plan.

In our case, the files are named: 20251031_version_migrations

Here is the corresponding sqitch.plan:
```bash
%syntax-version=1.0.0
%project=messaging

20251031_version_migrations 2025-10-31T13:34:46Z sqitch <sqitch@53cf65d3ae71>

```

Remove -- XXX Add DDLs here. and complete the three SQL files.

```bash

# Deploy
-- Generated by the message table.
CREATE TABLE message(
    id SERIAL NOT NULL,
    fk_user_id integer NOT NULL,
    message_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    logout_time timestamp without time zone,
);

# Revert

DROP TABLE IF EXISTS message;

# Verify

SELECT 1 FROM message LIMIT 1;

```

8. Run Sqitch actions on PostgreSQL

Replace <action> with one of the following:
- deploy → Apply creation or modification scripts
- revert → Undo changes applied in deploy/
- verify → Check that the migration was successfully applied

If this command fails, you may need to remove the Sqitch registry.

```bash
$pw = Get-Content ./secrets/messaging_db_password.txt -Raw
docker run --rm -it `
  -v "${PWD}/services/messaging-service/migrations:/repo" `
  --network securecloud_default `
  -e PGPASSWORD="$pw" `
  sqitch/sqitch:latest `
  <action> db:pg://postgres@messaging-db:5432/messaging_service --chdir /repo/
```

9. Deploy migrations (direct command)

If needed, you can directly run the deploy command:

```bash
$pw = Get-Content ./secrets/messaging_db_password.txt -Raw
docker run --rm -it `
  -v "${PWD}/services/messaging-service/migrations:/repo" `
  --network securecloud_default `
  -e PGPASSWORD="$pw" `
  sqitch/sqitch:latest `
  deploy db:pg://postgres@messaging-db:5432/messaging_service --chdir /repo/
```